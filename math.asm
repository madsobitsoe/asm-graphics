        BITS 64
        global cast_ray
        global check_bounds
        global clamp
        global clamp_degrees

check_bounds:
        ;; preconds
        ;; x should be in rax
        ;; y should be in rdx
        ;; img_width,img_height (in pixels) as img_width << 32 | img_height should
        ;; be in rcx
        ;; postconds
        ;; rax = 0 if success
        ;; rax = -1 if oob
        push rcx
        cmp rax, 0              ; x < 0
        jl check_bounds_exit_error
        cmp rdx, 0              ; y < 0
        jl check_bounds_exit_error
        shr rcx, 32
        cmp rax, rcx            ; x > width
        jg check_bounds_exit_error
        mov rcx, [rsp]
        shl rcx, 32
        shr rcx, 32
        cmp rdx, rcx            ; y > height
        jg check_bounds_exit_error
        mov rax, 0
        jmp check_bounds_exit
check_bounds_exit_error:
        mov rax, -1
check_bounds_exit:
        pop rcx
        ret


clamp:
        ;; preconds
        ;; x should be in rax
        ;; y should be in rdx
        ;; img_width,img_height (in pixels) as img_width << 32 | img_height should
        ;; be in rcx
        ;; postconds
        ;; x,y clamped to fit inside img
        ;; rax= clamped_x
        ;; rdx = clamped_y

        push rcx
clamp_x_min:
        cmp rax, 0              ; x < 0
        jge clamp_x_max
        mov rax, 0
        jmp clamp_y_min
clamp_x_max:
        shr rcx, 32
        cmp rax, rcx            ;x > width
        jle clamp_y_min
        mov rax, rcx
clamp_y_min:
        cmp rdx,0
        jge clamp_y_max
        mov rdx, 0
        jmp clamp_exit
clamp_y_max:
        mov rcx,[rsp]
        shl rcx,32
        shr rcx, 32
        cmp rdx, rcx
        jle clamp_exit
        mov rdx, rcx
clamp_exit:
        pop rcx
        ret

clamp_degrees:
        ;; make sure all degrees are between 0 and 359
        ;; degrees in rax
        ;; Check if larger than max
        cmp rax, 360
        jl clamp_degrees_below
clamp_degrees_above:
        ;; degrees >= 360
        sub rax, 360            ; degrees -= 360
        cmp rax, 360
        jge clamp_degrees_above ; subtract 360 again
        jmp clamp_degrees_done  ; woohoo
clamp_degrees_below:
        cmp rax, 0
        jge clamp_degrees_done
        add rax, 360
        jmp clamp_degrees_below
clamp_degrees_done:
        ret


cast_ray:
        ;; origin_x << 32 | origin_y in rax
        ;; distance c << 32 | angle in degrees in rbx
        ;; returns:
        ;; rax = origin_x << 48 | origin_y << 32 | new_x << 16 | new_y
        push rdx                         ; Save for good measure
        push rdi                         ; Save for good measure
        push r8                          ; use for origin_x
        push r9                          ; use for origin_y
        push r10                         ; use for new_x
        push r11                         ; use for new_y
        mov r9d, eax                     ; store origin_y in r9
        shr rax, 32                      ; origin_x
        mov r8, rax                      ; store origin_x in r8

        mov edi, ebx                     ; rdi = angle in degrees
        shr rbx, 32                      ; distance
        ;; compute new_y
        cvtsi2ss xmm0, ebx               ; distance in float reg
        mulss xmm0, [sintable + 4 * edi] ; c * sin(angle)
        cvtss2si r11, xmm0               ; new_y = int(c * sin(angle))
        add r11, r9                      ; new_y = origin_y + int(c * sin(angle))
        ;; compute new_x
        cvtsi2ss xmm0, ebx               ; distance in float reg
        mulss xmm0, [costable + 4 * edi] ; c * cos(angle)
        cvtss2si r10, xmm0               ; new_x = int(c * cos(angle))
        add r10, r8                      ; new_x = origin_x + int(c * cos(angle))
        mov rax, r8                      ; rax = origin_x
        shl rax, 16                      ; rax = origin_x << 16
        or  rax, r9                      ; rax = origin_x << 16 | origin_y
        shl rax, 16                      ; rax = origin_x << 32 | origin_y << 16
        or  rax, r10                     ; rax = origin_x << 32 | origin_y << 16 | new_x
        shl rax, 16                      ; rax = origin_x << 48 | origin_y << 32 | new_x << 16
        or rax, r11                      ; rax = origin_x << 48 | origin_y << 32 | new_x << 16 | new_y

        pop r11                          ; Restore for good measure
        pop r10                          ; Restore for good measure
        pop r9                           ; Restore for good measure
        pop r8                           ; Restore for good measure
        pop rdi                          ; Restore for good measure
        pop rdx                          ; Restore for good measure
        ret



section .rodata
sintable:
dd 0.0
dd 0.0174524064373
dd 0.0348994967025
dd 0.0523359562429
dd 0.0697564737441
dd 0.0871557427477
dd 0.104528463268
dd 0.121869343405
dd 0.13917310096
dd 0.15643446504
dd 0.173648177667
dd 0.190808995377
dd 0.207911690818
dd 0.224951054344
dd 0.2419218956
dd 0.258819045103
dd 0.275637355817
dd 0.292371704723
dd 0.309016994375
dd 0.325568154457
dd 0.342020143326
dd 0.358367949545
dd 0.374606593416
dd 0.390731128489
dd 0.406736643076
dd 0.422618261741
dd 0.438371146789
dd 0.45399049974
dd 0.469471562786
dd 0.484809620246
dd 0.5
dd 0.51503807491
dd 0.529919264233
dd 0.544639035015
dd 0.559192903471
dd 0.573576436351
dd 0.587785252292
dd 0.601815023152
dd 0.615661475326
dd 0.62932039105
dd 0.642787609687
dd 0.656059028991
dd 0.669130606359
dd 0.681998360062
dd 0.694658370459
dd 0.707106781187
dd 0.719339800339
dd 0.731353701619
dd 0.743144825477
dd 0.754709580223
dd 0.766044443119
dd 0.777145961457
dd 0.788010753607
dd 0.798635510047
dd 0.809016994375
dd 0.819152044289
dd 0.829037572555
dd 0.838670567945
dd 0.848048096156
dd 0.857167300702
dd 0.866025403784
dd 0.874619707139
dd 0.882947592859
dd 0.891006524188
dd 0.898794046299
dd 0.906307787037
dd 0.913545457643
dd 0.920504853452
dd 0.927183854567
dd 0.933580426497
dd 0.939692620786
dd 0.945518575599
dd 0.951056516295
dd 0.956304755963
dd 0.961261695938
dd 0.965925826289
dd 0.970295726276
dd 0.974370064785
dd 0.978147600734
dd 0.981627183448
dd 0.984807753012
dd 0.987688340595
dd 0.990268068742
dd 0.992546151641
dd 0.994521895368
dd 0.996194698092
dd 0.99756405026
dd 0.998629534755
dd 0.999390827019
dd 0.999847695156
dd 1.0
dd 0.999847695156
dd 0.999390827019
dd 0.998629534755
dd 0.99756405026
dd 0.996194698092
dd 0.994521895368
dd 0.992546151641
dd 0.990268068742
dd 0.987688340595
dd 0.984807753012
dd 0.981627183448
dd 0.978147600734
dd 0.974370064785
dd 0.970295726276
dd 0.965925826289
dd 0.961261695938
dd 0.956304755963
dd 0.951056516295
dd 0.945518575599
dd 0.939692620786
dd 0.933580426497
dd 0.927183854567
dd 0.920504853452
dd 0.913545457643
dd 0.906307787037
dd 0.898794046299
dd 0.891006524188
dd 0.882947592859
dd 0.874619707139
dd 0.866025403784
dd 0.857167300702
dd 0.848048096156
dd 0.838670567945
dd 0.829037572555
dd 0.819152044289
dd 0.809016994375
dd 0.798635510047
dd 0.788010753607
dd 0.777145961457
dd 0.766044443119
dd 0.754709580223
dd 0.743144825477
dd 0.731353701619
dd 0.719339800339
dd 0.707106781187
dd 0.694658370459
dd 0.681998360062
dd 0.669130606359
dd 0.656059028991
dd 0.642787609687
dd 0.62932039105
dd 0.615661475326
dd 0.601815023152
dd 0.587785252292
dd 0.573576436351
dd 0.559192903471
dd 0.544639035015
dd 0.529919264233
dd 0.51503807491
dd 0.5
dd 0.484809620246
dd 0.469471562786
dd 0.45399049974
dd 0.438371146789
dd 0.422618261741
dd 0.406736643076
dd 0.390731128489
dd 0.374606593416
dd 0.358367949545
dd 0.342020143326
dd 0.325568154457
dd 0.309016994375
dd 0.292371704723
dd 0.275637355817
dd 0.258819045103
dd 0.2419218956
dd 0.224951054344
dd 0.207911690818
dd 0.190808995377
dd 0.173648177667
dd 0.15643446504
dd 0.13917310096
dd 0.121869343405
dd 0.104528463268
dd 0.0871557427477
dd 0.0697564737441
dd 0.0523359562429
dd 0.0348994967025
dd 0.0174524064373
dd 1.22464679915e-16
dd -0.0174524064373
dd -0.0348994967025
dd -0.0523359562429
dd -0.0697564737441
dd -0.0871557427477
dd -0.104528463268
dd -0.121869343405
dd -0.13917310096
dd -0.15643446504
dd -0.173648177667
dd -0.190808995377
dd -0.207911690818
dd -0.224951054344
dd -0.2419218956
dd -0.258819045103
dd -0.275637355817
dd -0.292371704723
dd -0.309016994375
dd -0.325568154457
dd -0.342020143326
dd -0.358367949545
dd -0.374606593416
dd -0.390731128489
dd -0.406736643076
dd -0.422618261741
dd -0.438371146789
dd -0.45399049974
dd -0.469471562786
dd -0.484809620246
dd -0.5
dd -0.51503807491
dd -0.529919264233
dd -0.544639035015
dd -0.559192903471
dd -0.573576436351
dd -0.587785252292
dd -0.601815023152
dd -0.615661475326
dd -0.62932039105
dd -0.642787609687
dd -0.656059028991
dd -0.669130606359
dd -0.681998360062
dd -0.694658370459
dd -0.707106781187
dd -0.719339800339
dd -0.731353701619
dd -0.743144825477
dd -0.754709580223
dd -0.766044443119
dd -0.777145961457
dd -0.788010753607
dd -0.798635510047
dd -0.809016994375
dd -0.819152044289
dd -0.829037572555
dd -0.838670567945
dd -0.848048096156
dd -0.857167300702
dd -0.866025403784
dd -0.874619707139
dd -0.882947592859
dd -0.891006524188
dd -0.898794046299
dd -0.906307787037
dd -0.913545457643
dd -0.920504853452
dd -0.927183854567
dd -0.933580426497
dd -0.939692620786
dd -0.945518575599
dd -0.951056516295
dd -0.956304755963
dd -0.961261695938
dd -0.965925826289
dd -0.970295726276
dd -0.974370064785
dd -0.978147600734
dd -0.981627183448
dd -0.984807753012
dd -0.987688340595
dd -0.990268068742
dd -0.992546151641
dd -0.994521895368
dd -0.996194698092
dd -0.99756405026
dd -0.998629534755
dd -0.999390827019
dd -0.999847695156
dd -1.0
dd -0.999847695156
dd -0.999390827019
dd -0.998629534755
dd -0.99756405026
dd -0.996194698092
dd -0.994521895368
dd -0.992546151641
dd -0.990268068742
dd -0.987688340595
dd -0.984807753012
dd -0.981627183448
dd -0.978147600734
dd -0.974370064785
dd -0.970295726276
dd -0.965925826289
dd -0.961261695938
dd -0.956304755963
dd -0.951056516295
dd -0.945518575599
dd -0.939692620786
dd -0.933580426497
dd -0.927183854567
dd -0.920504853452
dd -0.913545457643
dd -0.906307787037
dd -0.898794046299
dd -0.891006524188
dd -0.882947592859
dd -0.874619707139
dd -0.866025403784
dd -0.857167300702
dd -0.848048096156
dd -0.838670567945
dd -0.829037572555
dd -0.819152044289
dd -0.809016994375
dd -0.798635510047
dd -0.788010753607
dd -0.777145961457
dd -0.766044443119
dd -0.754709580223
dd -0.743144825477
dd -0.731353701619
dd -0.719339800339
dd -0.707106781187
dd -0.694658370459
dd -0.681998360062
dd -0.669130606359
dd -0.656059028991
dd -0.642787609687
dd -0.62932039105
dd -0.615661475326
dd -0.601815023152
dd -0.587785252292
dd -0.573576436351
dd -0.559192903471
dd -0.544639035015
dd -0.529919264233
dd -0.51503807491
dd -0.5
dd -0.484809620246
dd -0.469471562786
dd -0.45399049974
dd -0.438371146789
dd -0.422618261741
dd -0.406736643076
dd -0.390731128489
dd -0.374606593416
dd -0.358367949545
dd -0.342020143326
dd -0.325568154457
dd -0.309016994375
dd -0.292371704723
dd -0.275637355817
dd -0.258819045103
dd -0.2419218956
dd -0.224951054344
dd -0.207911690818
dd -0.190808995377
dd -0.173648177667
dd -0.15643446504
dd -0.13917310096
dd -0.121869343405
dd -0.104528463268
dd -0.0871557427477
dd -0.0697564737441
dd -0.0523359562429
dd -0.0348994967025
dd -0.0174524064373
costable:
dd 1.0
dd 0.999847695156
dd 0.999390827019
dd 0.998629534755
dd 0.99756405026
dd 0.996194698092
dd 0.994521895368
dd 0.992546151641
dd 0.990268068742
dd 0.987688340595
dd 0.984807753012
dd 0.981627183448
dd 0.978147600734
dd 0.974370064785
dd 0.970295726276
dd 0.965925826289
dd 0.961261695938
dd 0.956304755963
dd 0.951056516295
dd 0.945518575599
dd 0.939692620786
dd 0.933580426497
dd 0.927183854567
dd 0.920504853452
dd 0.913545457643
dd 0.906307787037
dd 0.898794046299
dd 0.891006524188
dd 0.882947592859
dd 0.874619707139
dd 0.866025403784
dd 0.857167300702
dd 0.848048096156
dd 0.838670567945
dd 0.829037572555
dd 0.819152044289
dd 0.809016994375
dd 0.798635510047
dd 0.788010753607
dd 0.777145961457
dd 0.766044443119
dd 0.754709580223
dd 0.743144825477
dd 0.731353701619
dd 0.719339800339
dd 0.707106781187
dd 0.694658370459
dd 0.681998360062
dd 0.669130606359
dd 0.656059028991
dd 0.642787609687
dd 0.62932039105
dd 0.615661475326
dd 0.601815023152
dd 0.587785252292
dd 0.573576436351
dd 0.559192903471
dd 0.544639035015
dd 0.529919264233
dd 0.51503807491
dd 0.5
dd 0.484809620246
dd 0.469471562786
dd 0.45399049974
dd 0.438371146789
dd 0.422618261741
dd 0.406736643076
dd 0.390731128489
dd 0.374606593416
dd 0.358367949545
dd 0.342020143326
dd 0.325568154457
dd 0.309016994375
dd 0.292371704723
dd 0.275637355817
dd 0.258819045103
dd 0.2419218956
dd 0.224951054344
dd 0.207911690818
dd 0.190808995377
dd 0.173648177667
dd 0.15643446504
dd 0.13917310096
dd 0.121869343405
dd 0.104528463268
dd 0.0871557427477
dd 0.0697564737441
dd 0.0523359562429
dd 0.0348994967025
dd 0.0174524064373
dd 6.12323399574e-17
dd -0.0174524064373
dd -0.0348994967025
dd -0.0523359562429
dd -0.0697564737441
dd -0.0871557427477
dd -0.104528463268
dd -0.121869343405
dd -0.13917310096
dd -0.15643446504
dd -0.173648177667
dd -0.190808995377
dd -0.207911690818
dd -0.224951054344
dd -0.2419218956
dd -0.258819045103
dd -0.275637355817
dd -0.292371704723
dd -0.309016994375
dd -0.325568154457
dd -0.342020143326
dd -0.358367949545
dd -0.374606593416
dd -0.390731128489
dd -0.406736643076
dd -0.422618261741
dd -0.438371146789
dd -0.45399049974
dd -0.469471562786
dd -0.484809620246
dd -0.5
dd -0.51503807491
dd -0.529919264233
dd -0.544639035015
dd -0.559192903471
dd -0.573576436351
dd -0.587785252292
dd -0.601815023152
dd -0.615661475326
dd -0.62932039105
dd -0.642787609687
dd -0.656059028991
dd -0.669130606359
dd -0.681998360062
dd -0.694658370459
dd -0.707106781187
dd -0.719339800339
dd -0.731353701619
dd -0.743144825477
dd -0.754709580223
dd -0.766044443119
dd -0.777145961457
dd -0.788010753607
dd -0.798635510047
dd -0.809016994375
dd -0.819152044289
dd -0.829037572555
dd -0.838670567945
dd -0.848048096156
dd -0.857167300702
dd -0.866025403784
dd -0.874619707139
dd -0.882947592859
dd -0.891006524188
dd -0.898794046299
dd -0.906307787037
dd -0.913545457643
dd -0.920504853452
dd -0.927183854567
dd -0.933580426497
dd -0.939692620786
dd -0.945518575599
dd -0.951056516295
dd -0.956304755963
dd -0.961261695938
dd -0.965925826289
dd -0.970295726276
dd -0.974370064785
dd -0.978147600734
dd -0.981627183448
dd -0.984807753012
dd -0.987688340595
dd -0.990268068742
dd -0.992546151641
dd -0.994521895368
dd -0.996194698092
dd -0.99756405026
dd -0.998629534755
dd -0.999390827019
dd -0.999847695156
dd -1.0
dd -0.999847695156
dd -0.999390827019
dd -0.998629534755
dd -0.99756405026
dd -0.996194698092
dd -0.994521895368
dd -0.992546151641
dd -0.990268068742
dd -0.987688340595
dd -0.984807753012
dd -0.981627183448
dd -0.978147600734
dd -0.974370064785
dd -0.970295726276
dd -0.965925826289
dd -0.961261695938
dd -0.956304755963
dd -0.951056516295
dd -0.945518575599
dd -0.939692620786
dd -0.933580426497
dd -0.927183854567
dd -0.920504853452
dd -0.913545457643
dd -0.906307787037
dd -0.898794046299
dd -0.891006524188
dd -0.882947592859
dd -0.874619707139
dd -0.866025403784
dd -0.857167300702
dd -0.848048096156
dd -0.838670567945
dd -0.829037572555
dd -0.819152044289
dd -0.809016994375
dd -0.798635510047
dd -0.788010753607
dd -0.777145961457
dd -0.766044443119
dd -0.754709580223
dd -0.743144825477
dd -0.731353701619
dd -0.719339800339
dd -0.707106781187
dd -0.694658370459
dd -0.681998360062
dd -0.669130606359
dd -0.656059028991
dd -0.642787609687
dd -0.62932039105
dd -0.615661475326
dd -0.601815023152
dd -0.587785252292
dd -0.573576436351
dd -0.559192903471
dd -0.544639035015
dd -0.529919264233
dd -0.51503807491
dd -0.5
dd -0.484809620246
dd -0.469471562786
dd -0.45399049974
dd -0.438371146789
dd -0.422618261741
dd -0.406736643076
dd -0.390731128489
dd -0.374606593416
dd -0.358367949545
dd -0.342020143326
dd -0.325568154457
dd -0.309016994375
dd -0.292371704723
dd -0.275637355817
dd -0.258819045103
dd -0.2419218956
dd -0.224951054344
dd -0.207911690818
dd -0.190808995377
dd -0.173648177667
dd -0.15643446504
dd -0.13917310096
dd -0.121869343405
dd -0.104528463268
dd -0.0871557427477
dd -0.0697564737441
dd -0.0523359562429
dd -0.0348994967025
dd -0.0174524064373
dd -1.83697019872e-16
dd 0.0174524064373
dd 0.0348994967025
dd 0.0523359562429
dd 0.0697564737441
dd 0.0871557427477
dd 0.104528463268
dd 0.121869343405
dd 0.13917310096
dd 0.15643446504
dd 0.173648177667
dd 0.190808995377
dd 0.207911690818
dd 0.224951054344
dd 0.2419218956
dd 0.258819045103
dd 0.275637355817
dd 0.292371704723
dd 0.309016994375
dd 0.325568154457
dd 0.342020143326
dd 0.358367949545
dd 0.374606593416
dd 0.390731128489
dd 0.406736643076
dd 0.422618261741
dd 0.438371146789
dd 0.45399049974
dd 0.469471562786
dd 0.484809620246
dd 0.5
dd 0.51503807491
dd 0.529919264233
dd 0.544639035015
dd 0.559192903471
dd 0.573576436351
dd 0.587785252292
dd 0.601815023152
dd 0.615661475326
dd 0.62932039105
dd 0.642787609687
dd 0.656059028991
dd 0.669130606359
dd 0.681998360062
dd 0.694658370459
dd 0.707106781187
dd 0.719339800339
dd 0.731353701619
dd 0.743144825477
dd 0.754709580223
dd 0.766044443119
dd 0.777145961457
dd 0.788010753607
dd 0.798635510047
dd 0.809016994375
dd 0.819152044289
dd 0.829037572555
dd 0.838670567945
dd 0.848048096156
dd 0.857167300702
dd 0.866025403784
dd 0.874619707139
dd 0.882947592859
dd 0.891006524188
dd 0.898794046299
dd 0.906307787037
dd 0.913545457643
dd 0.920504853452
dd 0.927183854567
dd 0.933580426497
dd 0.939692620786
dd 0.945518575599
dd 0.951056516295
dd 0.956304755963
dd 0.961261695938
dd 0.965925826289
dd 0.970295726276
dd 0.974370064785
dd 0.978147600734
dd 0.981627183448
dd 0.984807753012
dd 0.987688340595
dd 0.990268068742
dd 0.992546151641
dd 0.994521895368
dd 0.996194698092
dd 0.99756405026
dd 0.998629534755
dd 0.999390827019
dd 0.999847695156
